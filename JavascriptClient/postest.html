<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>POS Scan Page</title>
    <link href="res/css/style.css" rel="stylesheet"/>
	<link href="res/css/lightbox.css" rel="stylesheet" />

    <script src="res/js/shortcuts.js"></script>
    <script src="res/js/lightbox.js"></script>
	<script src="res/js/W3Lightbox.js"></script>
	<script src="res/js/soundPlayer.js"></script>
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8080/signalr/hubs"></script>
</head>
<body>

    <div id="page">
        <div id="header">
			<div id="connectionStatus">...</div>
			<h1><img src="res/images/tbn_back_office.jpg" style="height:1em;vertical-align:top;"> Point Of Sale</h1>
		</div>
        <div id="content">
            <div id="right">
                <div style="padding:10px;">
                    <div>
                        Sub-total: <span id="orderSubtotal">0</span> $<br>
                        Fees: <span id="orderFees">0</span> $<br>
                        Shipping: <span id="orderShipping">0</span> $<br>
                        Taxes: <span id="orderTaxes">0</span> $<br>
                        TOTAL: <span id="orderTotal">0</span> $<br>
                    </div>
                    <div id="orderActions">
                        <button id="AddBackOrdered">Search Inventory</button><br>
                        <button id="linkCust">Link customer info</button><br>
                        <button id="">RMA</button><br>
                        <button id="cancelButton">Cancel</button><br>
                    </div>

                </div>
            </div>

            <div id="left">
                <div style="padding:10px;">
                    <ul id="productList"></ul>
                </div>
            </div>
        </div>
        <div id="scanControls">
            <div id="scanFormContainer">
                <form id="scanForm">
                    <input id="scanned" type="text" style="">
                </form>
            </div>
            <button id="submitOrder">Payment</button>
        </div>

    </div>
    <script>
        'use strict';
        /**
		TODO:
		ALLOW adding qty from local inv & warehouse when ordering backordered
		ALLOW editing qty of scanned items
		*/
        SoundPlayer.add('itemAdded', 'res/sounds/itemAdded1.ogg');
        SoundPlayer.add('itemScanned', 'res/sounds/itemScanned1.ogg');
        SoundPlayer.add('itemUnknown', 'res/sounds/itemUnknown1.ogg');

        var networkDelay = 100;
        var STATUS_WAITING = "WAITING",
			STATUS_OK = "OK",
			STATUS_NOINFO = "NO_INFO",
			STATUS_CUSTOM = "CUSTOM",
			STATUS_FORDELIVERY = "FORDELIVERY",
			STATUS_CUSTOM_FORDELIVERY = "CUSTOM_FORDELIVERY";
        if (!String.prototype.includes) {
            String.prototype.includes = function () {
                'use strict';
                return String.prototype.indexOf.apply(this, arguments) !== -1;
            }
        }

        var np = 0;
        var scanForm = document.getElementById('scanForm');
        var scannedField = document.getElementById('scanned');
        var prodList = document.getElementById('productList');
        var submitOrderButton = document.getElementById('submitOrder');
        var addBackordered = document.getElementById('AddBackOrdered');
        var linkCustomerButton = document.getElementById('linkCust');
        var cancelButton = document.getElementById('cancelButton');

        cancelButton.onclick = function () { order.clear(); scannedField.focus(); };
        addBackordered.onclick = function () {
        	W3Lightbox.build({
        		title: "Inventory search",
        		content: getProductSearch(),
        		cancelOnBgClick: false,
        		buttons: [
					{
						label: 'OK',
						style: { color: '#fff', backgroundColor: '#0b0' },
						onclick: function () { this.lightbox.close(); }
					}]
        	}).show();
        };
        linkCustomerButton.onclick = function () {
        	//lightbox.setContent(getCustomerSearch()); lightbox.show();
        	W3Lightbox.build({
        		title: "Customer search",
        		content: getCustomerSearch(),
        		cancelOnBgClick: false,
        		buttons: [
					{
						label: 'OK',
						onclick: function () { this.lightbox.close(); }
					}]
        	}).show();
        };
        submitOrderButton.onclick = function () {
        	var submitOrderForm = {};
        	submitOrderForm = W3Lightbox.build({
        		title: "Payment",
        		content: getPaymentForm(),
        		cancelOnBgClick: false,
        		onshow: function () {
        			if (order.backorderedItems.length > 0 && (!order.customerInfo.name || !order.customerInfo.tel)) {
        				W3Lightbox.build({
        					title: 'Customer contact info',
        					content: getCustomerSearch('<b style="color:red">Customer info is required for orders containing backordered items. (Name and phone #)</b>'),
        					oncancel: function () {
        						submitOrderForm = null;
        						return true;
        					},
        					onclose: function () {
        						if (order.backorderedItems.length > 0 && (!order.customerInfo.name || !order.customerInfo.tel)) {
        							alert('Customer info required.');
        							return false;
        						}
        						submitOrderForm.show();
        						return true;
        					},
        					buttons: [{
        						label: 'Continue',
        						onclick: function () { this.lightbox.close(); }
        					}]
        				}).show();
        				return false;
        			}
        			return true;
        		}
        	});
        	submitOrderForm.show();
        };


        scanForm.onsubmit = function () {
            addProduct(scannedField.value);
            scannedField.value = "";
            return false;
        };

        function enableScan() {
            scannedField.removeAttribute('disabled');
        }
        function disableScan() {
            scannedField.setAttribute('disabled', 'true');
        }

        function addProduct(upc) {
            order.add(upc);
            redrawOrder();
        }

        function redrawOrder() {
            prodList.innerHTML = "";
            for (var k in order.items) {
                var currItem = order.items[k];
                var newProd = document.createElement('li');
                newProd.id = "sku" + np + "_" + currItem.item.upc;
                newProd.dataset.upc = currItem.item.upc;
                newProd.innerHTML = currItem.item.upc;
                prodList.appendChild(newProd);
                if (currItem.status == STATUS_OK) {
                    newProd.innerHTML = currItem.item.name + "<br><pre>\t\t\tX " + currItem.qty + "\t@ $" + currItem.item.price + "\t $" + (currItem.item.price * currItem.qty).toFixed(2) + "</pre>";
                } else if (currItem.status == STATUS_WAITING) {
                    newProd.innerHTML = currItem.item.upc + ": waiting..." + "<br><pre>\t\t\tX " + currItem.qty + "</pre>";
                } else if (currItem.status == STATUS_NOINFO) {
                    newProd.innerHTML = currItem.item.upc + " (" + (currItem.item.name || "?") + ") : No info available..." + "<br><pre>\t\t\tX " + currItem.qty + "</pre>";
                    newProd.dataset.status = STATUS_NOINFO;
                    newProd.onclick = function () { lightbox.setContent(getProductEditor(order.get(this.dataset.upc))); lightbox.show(); };
                } else if (currItem.status == STATUS_CUSTOM) {
                    newProd.innerHTML = (currItem.item.name || "ItemCode: " + currItem.item.upc) + "<br><pre>\t\t\tX " + currItem.qty + "\t@ $" + currItem.item.price + "\t $" + (currItem.item.price * currItem.qty).toFixed(2) + "</pre>";
                    newProd.dataset.status = STATUS_CUSTOM;
                    newProd.onclick = function () { lightbox.setContent(getProductEditor(order.get(this.dataset.upc))); lightbox.show(); };
                }
            }
            for (var k in order.backorderedItems) {
                var currItem = order.backorderedItems[k];
                var newProd = document.createElement('li');
                newProd.id = "sku" + np + "_" + currItem.item.upc;
                newProd.dataset.upc = currItem.item.upc;
                newProd.innerHTML = currItem.item.upc;
                prodList.appendChild(newProd);
                if (currItem.status == STATUS_FORDELIVERY) {
                    newProd.innerHTML = currItem.item.name + "<br><pre>\t\t\tX " + currItem.qty + "\t@ $" + currItem.item.price + "\t $" + (currItem.item.price * currItem.qty).toFixed(2) + "</pre>";
                    newProd.dataset.status = STATUS_FORDELIVERY;
                    newProd.onclick = function () {
                    	W3Lightbox.build({
                    		content: getBackorderedProductEditor(order.getBackordered(this.dataset.upc)),
                    		title:currItem.item.name,
                    		buttons: [
								{
									label: 'Update',
									onclick: function () { this.lightbox.dom.getElementsByTagName('form')[0].dispatchEvent(new Event('submit', {bubbles:true,cancelable:true})); }
								}
                    		]
                    	}).show();
                    };
                }
            }
            var ordertotal = order.getOrderTotal();
            /*USE A CLASS NAME INSTEAD AND UPDATE ALL ELEMENTS WITH THAT CLASS TO SHOW SUBTOTAL.*/
            document.getElementById('orderSubtotal').innerHTML = ordertotal.subtotal.toFixed(2);
            /*USE A CLASS NAME INSTEAD AND UPDATE ALL ELEMENTS WITH THAT CLASS TO SHOW TOTAL.*/
            document.getElementById('orderTotal').innerHTML = ordertotal.total.toFixed(2);
            /*USE A CLASS NAME INSTEAD AND UPDATE ALL ELEMENTS WITH THAT CLASS TO SHOW SHIPPING.*/
            document.getElementById('orderShipping').innerHTML = ordertotal.shipping.toFixed(2);
            /*USE A CLASS NAME INSTEAD AND UPDATE ALL ELEMENTS WITH THAT CLASS TO SHOW FEES.*/
            document.getElementById('orderFees').innerHTML = ordertotal.fees.toFixed(2);
            /*USE A CLASS NAME INSTEAD AND UPDATE ALL ELEMENTS WITH THAT CLASS TO SHOW TAX.*/
            document.getElementById('orderTaxes').innerHTML = (ordertotal.tax1 + ordertotal.tax2).toFixed(2);
        }

        function displayInventory(inventory) {
            console.log(inventory);
            for (var i in inventory) {
                [].forEach.call(document.querySelectorAll('.localInv[data-upc="' + inventory[i].upc + '"]'), function (x) { x.innerHTML = inventory[i].localinv });
                if (inventory[i].warehouse.length == 0) {
                    [].forEach.call(document.querySelectorAll('.whInv[data-upc="' + inventory[i].upc + '"]'), function (x) { x.innerHTML = 'N/A' });
                } else {
                    var totalWhInv = 0;
                    var detailWhInv = '';
                    for (var wh in inventory[i].warehouse) {
                        totalWhInv += inventory[i].warehouse[wh].inv;
                        detailWhInv += inventory[i].warehouse[wh].location + ':' + inventory[i].warehouse[wh].inv + ', ';
                    }
                    detailWhInv = detailWhInv.trim().slice(0, -1);
                    [].forEach.call(document.querySelectorAll('.whInv[data-upc="' + inventory[i].upc + '"]'), function (x) {
                        x.innerHTML = totalWhInv;
                        x.title = detailWhInv;
                    });
                }
            }
        }

        //*
        scannedField.focus();
        //scannedField.onblur=function(){setTimeout(function(){scannedField.focus();}, 5);};
        //window.onfocus=function(){setTimeout(function(){scannedField.focus();}, 5);};
        //*
        document.onkeypress = documentkeypress;

        scannedField.onkeypress = fieldkeypress;
        //*/
        function fieldkeypress(e) {
            //might not work in all browsers, deal with it.
            if (e.key.toLowerCase() == "esc" || e.key.toLowerCase() == "escape") {
                e.target.blur();
            }
            e.cancelBubble = true;
        }

        function documentkeypress(e) {
            //might not work in all browsers, deal with it.
            if (e.key.toLowerCase() == "insert") {
                scannedField.focus();
            } 
            e.cancelBubble = true;
        }

		function getCustomerSearch(message) {
			var cSearch = document.createElement('div');
			cSearch.innerHTML = ((message) ? '<p>' + message + '</p>' : '') + '<div id="currentlySelectedCustomer" style="float:right";></div><form>Customer ID <label><input type="text" name="custId"></label><br>' +
					'<label >Name <input type="text" name="custName"></label><br>' +
					'<label >Email <input type="text" name="custEmail"></label><br>' +
					'<label>Tel. <input type="text" name="custTel"></label><br>' +
					'<label>Address1<input type="text" name="custAddress1"></label><br>' +
				'</form>';

            var custSearchButton = document.createElement('button');
            custSearchButton.innerHTML = "Search";
            cSearch.getElementsByTagName('form')[0].appendChild(custSearchButton);

            var newCustButton = document.createElement('button');
            newCustButton.innerHTML = "newCust";
            cSearch.getElementsByTagName('form')[0].appendChild(newCustButton);

            var searchResultsContainer = document.createElement('div');
            searchResultsContainer.id = "searchResultsContainer";
            cSearch.appendChild(searchResultsContainer);

            var redrawCustInfo = function (container) {
                container.innerHTML = '<b>Customer Info</b><br>' + order.customerInfo.customerId + '<br>' +
					order.customerInfo.name + '<br>' +
					order.customerInfo.email + '<br>' +
					order.customerInfo.tel + '<br>' +
					order.customerInfo.address1;
            }
            redrawCustInfo(cSearch.getElementsByTagName('div')[0]);

            var clearCustomerHandler = function () {
                order.customerInfo = {};
                redrawCustInfo(document.getElementById('currentlySelectedCustomer'));
                if (!!document.querySelector("#searchResultsContainer .addedItem")) {
                    document.querySelector("#searchResultsContainer .addedItem").onclick = setCustomerHandler;
                    document.querySelector("#searchResultsContainer .addedItem").classList.remove('addedItem');
                }
            };
            var setCustomerHandler = function () {
                clearCustomerHandler();
                this.classList.add("addedItem");
                order.customerInfo = this.cust;
                redrawCustInfo(document.getElementById('currentlySelectedCustomer'));
                this.onclick = clearCustomerHandler;
            };

            custSearchButton.onclick = function (e) {
                searchResultsContainer.innerHTML = "";
                searchResultsContainer.style.background = 'url("res/images/staticspinner.gif") no-repeat scroll center transparent';
                var form = e.target.parentElement;

                var searchTerms = { customerId: form.custId.value, name: form.custName.value, email: form.custEmail.value, tel: form.custTel.value, address1: form.custAddress1.value };
                setTimeout(function () {
                    searchResultsContainer.innerHTML = "";
                    searchResultsContainer.style.background = "none";
                    var res = customerDB.search(searchTerms);
                    if (res.length < 1) {
                        searchResultsContainer.innerHTML = "<b>No Customers found. Verify customer info or create a new account.</b>"
                    } else {
                        for (var r = 0; r < res.length; r++) {
                            var c_li = document.createElement('li');
                            c_li.cust = res[r];
                            c_li.innerHTML += res[r].name + ', ' + res[r].tel;
                            if (order.customerInfo === res[r]) {
                                c_li.classList.add("addedItem");
                                c_li.onclick = clearCustomerHandler;
                            } else {
                                c_li.onclick = setCustomerHandler;
                            }

                            searchResultsContainer.appendChild(c_li);
                        }
                    }
                }, networkDelay);

                return false;
            }

            newCustButton.onclick = function (e) {
                searchResultsContainer.innerHTML = "";
                clearCustomerHandler();
                var form = e.target.parentElement;
                order.customerInfo = { customerId: form.custId.value, name: form.custName.value, email: form.custEmail.value, tel: form.custTel.value, address1: form.custAddress1.value };
                redrawCustInfo(document.getElementById('currentlySelectedCustomer'));
                return false;
            }
            return cSearch;
        }

        function getProductEditor(edItem) {
            var upc = edItem.item.upc;
            if (edItem == null) { alert("Error"); return; }
            var prodEd = document.createElement('form');
            prodEd.innerHTML = '<label>UPC</label> <input name="edUPC" disabled type="text" value="' + upc + '"><br>' +
				'<label>Mfg part no</label> <input name="edMfgno"  type="text" value="' + ((!!edItem.item.mfgpartno) ? edItem.item.mfgpartno : "") + '"><br>' +
				'<label>Item</label> <input name="edName"  type="text" value="' + ((!!edItem.item.name) ? edItem.item.name : "") + '"><br>' +
				'<label>Price</label> <input name="edPrice"  type="text" value="' + ((!!edItem.item.price) ? edItem.item.price : 0) + '"><br>' +
				'<label>Qty</label> <input name="edQty"  type="number" value="' + edItem.qty + '"><br>';
            var updateButton = document.createElement('button');
            updateButton.typr = "submit";
            updateButton.innerHTML = "Update";
            prodEd.appendChild(updateButton);
            prodEd.onsubmit = function (e) {
                var form = e.target;
                var price = form.edPrice.value;
                var qty = form.edQty.value;
                var status = (price > 0) ? STATUS_CUSTOM : STATUS_NOINFO;
                order.update(upc, { upc: upc, name: form.edName.value, mfgpartno: form.edMfgno.value, price: price }, status, qty);
                lightbox.hide();
                scannedField.focus();
                return true;
            }
            return prodEd;
        }

        function getBackorderedProductEditor(edItem) {
            var upc = edItem.item.upc;
            if (edItem == null) { alert("Error"); return; }
            var prodEd = document.createElement('form');
            prodEd.innerHTML = '<label>UPC</label> <input name="edUPC" disabled type="text" value="' + upc + '"><br>' +
				'<label>Mfg part no</label> <input name="edMfgno"  disabled type="text" value="' + ((!!edItem.item.mfgpartno) ? edItem.item.mfgpartno : "") + '"><br>' +
				'<label>Item</label> <input name="edName"  type="text" disabled value="' + ((!!edItem.item.name) ? edItem.item.name : "") + '"><br>' +
				'<label>Price</label> <input name="edPrice"  type="text" disabled value="' + ((!!edItem.item.price) ? edItem.item.price : 0) + '"><br>' +
				'<label>Qty</label> <input name="edQty"  type="number" value="' + edItem.qty + '"><br>'+
            	'<input type="submit" style="position: absolute; left: -9999px; width: 1px; height: 1px;"/>';
            prodEd.onsubmit = function (e) {
            	var form = prodEd;
                var qty = form.edQty.value;
                order.updateBackordered(upc, qty);
                scannedField.focus();
                return true;
            }
            return prodEd;
        }

        function getProductSearch() {
            var prodSearch = document.createElement('div');
            prodSearch.innerHTML = '<form><label>Search</label> <input name="productSearch"  type="text" > <button type="submit">Search</button></form>';

            var searchResultsContainer = document.createElement('div');
            searchResultsContainer.id = "searchResultsContainer";
            prodSearch.appendChild(searchResultsContainer);

            prodSearch.getElementsByTagName('form')[0].onsubmit = function (e) {
                searchResultsContainer.innerHTML = "";
                searchResultsContainer.style.background = 'url("res/images/staticspinner.gif") no-repeat scroll center transparent';
                var form = e.target;
                var searchT = form.productSearch.value;
                setTimeout(function () {
                    searchResultsContainer.innerHTML = "";
                    searchResultsContainer.style.background = "none";
                    var res = productDB.search(searchT);
                    if (res.length < 1) {
                        searchResultsContainer.innerHTML = "<b>NO PRODUCTS FOUND</b>"
                    } else {
                        var invToCheck = [];
                        for (var r = 0; r < res.length; r++) {
                            var p_li = document.createElement('li');
                            p_li.prod = res[r];
                            p_li.innerHTML += res[r].name + ' <span style="float:right;">$' + res[r].price + '</span><span class="liveInv"><span class="localInv" data-upc="' + res[r].upc + '">Getting local Inv...</span> | <span class="whInv" data-upc="' + res[r].upc + '">Getting wh Inv...</span></span>';
                            if (order.getBackordered(res[r].upc) != null) {
                                p_li.classList.add("addedItem");
                            } else {
                                p_li.onclick = function () { order.addBackorderedItem(this.prod); this.classList.add("addedItem"); this.onclick = function () { }; };
                            }

                            invToCheck.push(res[r].upc);
                            searchResultsContainer.appendChild(p_li);
                        }
                        productDB.getInventory(invToCheck, displayInventory);
                    }
                    //console.log(res);
                }, networkDelay);
                return false;
            }
            return prodSearch;
        }

        function getPaymentForm() {
            var payForm = document.createElement('div');
            //payform.innerHTML+='<form>';
            var missingPrice = false;
            for (var item in order.items) {
                var oItem = order.items[item]
                if (oItem.item.price == undefined || oItem.status == STATUS_WAITING || oItem.status == STATUS_NOINFO) {
                	payForm.innerHTML += '<b style="color:red;">Missing price info for item ' + (oItem.item.name || oItem.item.mfgpartno || oItem.item.upc) + '</b><br>';
                	missingPrice = true;
                }
            }
            if (missingPrice) {
                return payForm;
            }
            if (order.backorderedItems.length > 0) {
                var shipForm = document.createElement('form');
                shipForm.innerHTML = '<p><b>Select shipping method</b></p>' +
						'<input type="radio" id="shipMethodPickup" name="BackorderedShipMethod" value="Pickup" ' + ((order.shipMethod.toLowerCase() == 'pickup') ? 'checked' : '') + '>' +
						'<label for="shipMethodPickup">Pickup backordered</label>' +
						'<input type="radio" id="shipMethodShip" name="BackorderedShipMethod" value="Ship" ' + ((order.shipMethod.toLowerCase() == 'ship') ? 'checked' : '') + '>' +
						'<label for="shipMethodShip">Ship backordered</label>' +
						'<input type="radio" id="shipMethodShipAll" name="BackorderedShipMethod" value="ShipAll" ' + ((order.shipMethod.toLowerCase() == 'shipall') ? 'checked' : '') + '>' +
						'<label for="shipMethodShipAll">Ship all</label>' +
						'<br><br>';
                for (var shipM in shipForm.BackorderedShipMethod) {
                    shipForm.BackorderedShipMethod[shipM].onchange = function () { order.shipMethod = shipForm.BackorderedShipMethod.value; redrawOrder(); };
                }
                payForm.appendChild(shipForm);
            } else if (order.items.length < 1) {
                payForm.innerHTML = '<h1 style="color:red;">No items in order</h1>';
                return payForm;
            }

            var paymentMethodSelect = document.createElement('div');
            paymentMethodSelect.innerHTML = "<p><b>Select payment method</b></p>"
            /*PAYMENT METHOD*/
            /*TODO SELECT PAYMENT METHOD. ALLOW MULTIPLE PAYMENTS...*/
            /*PAYMENT METHOD*/
            payForm.appendChild(paymentMethodSelect);
            return payForm;
        }

        var customerDB = {
            customers: [
				{ customerId: "c1", name: "Customer1", email: "customer1@domain.tld", tel: "555-5555 ext:1", address1: "123 Street Drive" },
				{ customerId: "c2", name: "Customer2", email: "customer2@domain.tld", tel: "555-5555 ext:2", address1: "567 Blvd Crescent" },
				{ customerId: "c3", name: "Customer3", email: "customer3@domain.tld", tel: "555-5555 ext:3", address1: "894 Avenue Lane" }
            ],
            addCustomer: function (cId, n, e, t, a1) {
                this.customers.push({ customerId: cId, name: n, email: e, tel: t, address1: a1 });
            },
            search: function (cInfo) {
                var results = [];
                for (var customer in this.customers) {
                    var isMatch = false;
                    for (var cInfoField in cInfo) {
                        if (!!cInfo[cInfoField]) {
                            if (!this.customers[customer][cInfoField].toLowerCase().includes(cInfo[cInfoField].toLowerCase())) {
                                isMatch = false;
                                break;
                            }
                        } else { continue; }
                        isMatch = true;
                    }
                    if (isMatch) {
                        results.push(this.customers[customer]);
                    }
                }
                return results;
            }
        }

        var productDB = {
            products: [
				{ upc: "610839180820", mfgpartno: "M5A88-M", name: "ASUS M5A88-M Motherboard", price: "89.99" },
				{ upc: "812658011426", mfgpartno: "AS23S40700458", name: "Aluratek Android Tablet", price: "60.50" },
				{ upc: "9780321804334", mfgpartno: "54", name: "Android Programming", price: "51.99" },
				{ upc: "610839359400", mfgpartno: "90-C1CP6Z-L0AANAYZ", name: "EN210 SILENT/D1/1GD3/V2", price: "19.99" },
				{ upc: "885370249286", mfgpartno: "35H-00006", name: "Generic Mouse", price: "15.00" }
            ],
            inventoryList: [
				{ upc: "610839180820", localinv: 16, warehouse: [{ location: "Ottawa", inv: 0 }] },
				{ upc: "812658011426", localinv: 15, warehouse: [{ location: "Ottawa", inv: 33 }, { location: "Toronto", inv: 50 }] },
				{ upc: "9780321804334", localinv: 2, warehouse: [{ location: "Ottawa", inv: 22 }] },
				{ upc: "610839359400", localinv: 10, warehouse: [{ location: "Vancouver", inv: 19 }] },
				{ upc: "885370249286", localinv: 12, warehouse: [] }
            ],
            getInventory: function (upcList, callback) {
                var tInv = [];
                for (var u in upcList) {
                    for (var i in this.inventoryList) {
                        if (upcList[u] == this.inventoryList[i].upc) {
                            tInv.push(this.inventoryList[i]);
                            break;
                        }
                    }
                }
                setTimeout(function () { callback(tInv); }, networkDelay);
            },
            upcSearch: function (upc) {
                for (var product in this.products) {
                    if (this.products[product].upc == upc) {
                        return this.products[product];
                    }
                }
                return null;
            },
            search: function (searchTerm) {
                var results = [];
                for (var p in this.products) {
                    var isMatch = false;
                    for (var pInfoField in this.products[p]) {
                        if (this.products[p][pInfoField].toLowerCase().includes(searchTerm.toLowerCase())) {
                            isMatch = true;
                            break;
                        }
                    }
                    if (isMatch) {
                        results.push(this.products[p]);
                    }
                }
                return results;
            }
        }

        var order = {
        	items: [],
        	orderNo: Math.round(Math.random() * 100000),
            backorderedItems: [],
            payment: [],
            shipMethod: "",
            getOrderTotal: function () {
                var fees = 0;
                var tax1 = 0;
                var tax2 = 0;
                var shipping = 0;
                var subtotal = 0;
                for (var item in this.items) {
                    subtotal += (this.items[item].item.price * this.items[item].qty);
                }
                for (var item in this.backorderedItems) {
                    subtotal += (this.backorderedItems[item].item.price * this.backorderedItems[item].qty);
                }
                if (this.shipMethod.toLowerCase().includes("ship")) {
                    shipping = 5;
                }
                tax1 = ((subtotal + fees + shipping) * 0.13);
                tax2 = (subtotal + fees + shipping + tax1) * 0;
                var total = (subtotal + fees + shipping + tax1 + tax2);
                return { total: total, subtotal: subtotal, fees: fees, shipping: shipping, tax1: tax1, tax2: tax2 };
            },
            customerInfo: {},
            clear: function () { this.items = []; this.backorderedItems = []; this.customerInfo = {}; this.orderNo++; redrawOrder(); },
            addBackorderedItem: function (item/*,status*/) {
                for (var i = 0; i < this.backorderedItems.length; i++) {
                    if (this.backorderedItems[i].item.upc == item.upc) {
                        this.backorderedItems[i].qty++;
                        redrawOrder();
                        return;
                    }
                }
                this.backorderedItems.push({ item: item, qty: 1, status: STATUS_FORDELIVERY });
                redrawOrder();
            },
            add: function (upc, qty) {
                if (!qty) {
                    qty = 1;
                }
                disableScan();
                //this.items.push({item:{upc:upc,mfgpartno:null,name:null,price:null},qty:qty,status:STATUS_WAITING});
                setTimeout(function () {
                    var prod = productDB.upcSearch(upc);
                    if (prod != null) {
                        var itemNotAdded = true;
                        for (var i = 0; i < order.items.length; i++) {
                            if (order.items[i].item.upc == upc) {
                                order.items[i].qty++;
                                itemNotAdded = false;
                            }
                        }
                        if (itemNotAdded) {
                            order.items.push({ item: { upc: upc, mfgpartno: null, name: null, price: null }, qty: qty, status: STATUS_WAITING });
                            order.update(upc, prod, STATUS_OK);
                        }
                        redrawOrder();
                        SoundPlayer.play('itemAdded');
                    } else {
                        //order.update(upc,null,STATUS_NOINFO);
                    	SoundPlayer.play('itemUnknown');
                    	scannedField.blur();
                    	W3Lightbox.build({
                    		content: function () { var e = document.createElement('div'); e.innerHTML = '<h1 style="color:red;">UNKNOWN ITEM.</h1>'; return e; }(),
                    		closeButton: false,
							width:350
                    	}).show();
              
                    }
                    enableScan();
                }, networkDelay);
                redrawOrder();
            },
            update: function (upc, itemWithInfo, updatestatus, qty) {
                for (var i = 0; i < this.items.length; i++) {
                    if (this.items[i].item.upc == upc) {
                        if (!!itemWithInfo) {
                            this.items[i].item = itemWithInfo;
                        }
                        if (!!qty) {
                            this.items[i].qty = qty;
                        }
                        this.items[i].status = updatestatus;
                        if (qty <= 0) {
                            var that = this;
                            this.items = that.items.filter(function (x) { return !(x === that.items[i]) });
                        }
                        redrawOrder();
                        return;
                    }
                }
            },
            updateBackordered: function (upc, qty) {
                for (var i = 0; i < this.backorderedItems.length; i++) {
                    if (this.backorderedItems[i].item.upc == upc) {
                        this.backorderedItems[i].qty = qty;
                        if (qty <= 0) {
                            var that = this;
                            this.backorderedItems = that.backorderedItems.filter(function (x) { return !(x === that.backorderedItems[i]) });
                        }
                        redrawOrder();
                        return;
                    }
                }
            },
            get: function (upc) {
                for (var i = 0; i < this.items.length; i++) {
                    if (this.items[i].item.upc == upc) {
                        return (this.items[i]);
                    }
                }
                return null;
            },
            getBackordered: function (upc) {
                for (var i = 0; i < this.backorderedItems.length; i++) {
                    if (this.backorderedItems[i].item.upc == upc) {
                        return (this.backorderedItems[i]);
                    }
                }
                return null;
            }
        };
    </script>
    <script src="res/js/opos.js"></script>
</body>
</html>